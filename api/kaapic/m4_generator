#!/bin/sh
#
##
## xkaapi
## 
## Created on Tue Mar 31 15:19:14 2009
## Copyright 2009 INRIA.
##
## Contributors :
## thierry.gautier@inrialpes.fr
## fabien.lementec@imag.fr
## 
## This software is a computer program whose purpose is to execute
## multithreaded computation with data flow synchronization between
## threads.
## 
## This software is governed by the CeCILL-C license under French law
## and abiding by the rules of distribution of free software.  You can
## use, modify and/ or redistribute the software under the terms of
## the CeCILL-C license as circulated by CEA, CNRS and INRIA at the
## following URL "http://www.cecill.info".
## 
## As a counterpart to the access to the source code and rights to
## copy, modify and redistribute granted by the license, users are
## provided only with a limited warranty and the software's author,
## the holder of the economic rights, and the successive licensors
## have only limited liability.
## 
## In this respect, the user's attention is drawn to the risks
## associated with loading, using, modifying and/or developing or
## reproducing the software by the user in light of its specific
## status of free software, that may mean that it is complicated to
## manipulate, and that also therefore means that it is reserved for
## developers and experienced professionals having in-depth computer
## knowledge. Users are therefore encouraged to load and test the
## software's suitability as regards their requirements in conditions
## enabling the security of their systems and/or data to be ensured
## and, more generally, to use and operate it in the same conditions
## as regards security.
## 
## The fact that you are presently reading this means that you have
## had knowledge of the CeCILL-C license and that you accept its
## terms.
## 
## use:
#  m4_generator <NB_PARAM> 
#


makeheader() {
cat <<ENDDDD 
/* KAAPI/KaapiC interface interface */
// -----------------------------------------
// by Fabien Le Mentec and Thierry Gautier
//(c) INRIA, projet MOAIS, 2011
// See Copyright file.
/********************************************************
 WARNING! This file has been automatically generated by M4
 `date`
 *******************************************************/
ENDDDD
}

makeswitchdfg() {
cat <<ENDDDD 
#define KAAPIC_MAX_ARGS $MAX_NUMBER_PARAMS
#define KAAPIC_DFG_SWITCH(__ti) \\
switch((__ti)->nargs) { \\
ENDDDD
}

makeswitchdfgwh() {
cat <<ENDDDD 
#define KAAPIC_MAX_ARGS $MAX_NUMBER_PARAMS
#define KAAPIC_DFG_WH_SWITCH(__ti) \\
switch((__ti)->nargs) { \\
ENDDDD
}

makeswitchadaptative() {
cat <<ENDDDD 
#define KAAPIC_MAX_ARGS $MAX_NUMBER_PARAMS
#define KAAPIC_ADAPTIVE_SWITCH(__w, __i, __j, __tid) \\
switch((__w)->nargs) { \\
ENDDDD
}

makeswitchadaptativeull() {
cat <<ENDDDD 
#define KAAPIC_MAX_ARGS $MAX_NUMBER_PARAMS
#define KAAPIC_ADAPTIVE_SWITCH_ULL(__w, __i, __j, __tid) \\
switch((__w)->nargs) { \\
ENDDDD
}


makeendswitch() {
cat <<ENDDDD 
default: kaapi_abort(); break ;\\
}
ENDDDD
}



#############################################################
## loop for file bodies
#############################################################

NUMBER=0
COUNTER=$1
MAX_NUMBER_PARAMS=$1
## `expr $1 + 1`

makeheader > kaapic_dfg_switch.h
makeheader > kaapic_dfg_wh_switch.h
makeheader > kaapic_adaptive_switch.h
makeheader > kaapic_adaptive_switch_ull.h

makeswitchdfg >> kaapic_dfg_switch.h
makeswitchdfgwh >> kaapic_dfg_wh_switch.h
makeswitchadaptative >> kaapic_adaptive_switch.h
makeswitchadaptativeull >> kaapic_adaptive_switch_ull.h

while [ $COUNTER -ge 0 ]
do
      m4 -DKAAPI_NUMBER_PARAMS=$NUMBER -DKAAPI_MAX_NUMBER_PARAMS=$MAX_NUMBER_PARAMS m4_macros  kaapic_dfg_switch.m4 >> kaapic_dfg_switch.h
      m4 -DKAAPI_NUMBER_PARAMS=$NUMBER -DKAAPI_MAX_NUMBER_PARAMS=$MAX_NUMBER_PARAMS m4_macros  kaapic_dfg_wh_switch.m4 >> kaapic_dfg_wh_switch.h
      m4 -DKAAPI_NUMBER_PARAMS=$NUMBER -DKAAPI_MAX_NUMBER_PARAMS=$MAX_NUMBER_PARAMS m4_macros  kaapic_adaptive_switch.m4 >> kaapic_adaptive_switch.h
      m4 -DKAAPI_NUMBER_PARAMS=$NUMBER -DKAAPI_MAX_NUMBER_PARAMS=$MAX_NUMBER_PARAMS m4_macros  kaapic_adaptive_switch_ull.m4 >> kaapic_adaptive_switch_ull.h
      echo "Generating file: $file step $NUMBER :-)"
      NUMBER=`expr $NUMBER + 1`
      COUNTER=`expr $COUNTER - 1`
done

makeendswitch >> kaapic_dfg_switch.h
makeendswitch >> kaapic_dfg_wh_switch.h
makeendswitch >> kaapic_adaptive_switch.h
makeendswitch >> kaapic_adaptive_switch_ull.h

